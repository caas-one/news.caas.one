# 用于安全部署的Kubernetes许可控制器  (90)

作者：Kaizhe Huang 原文链接：[Kubernetes admission controllers for secure deployments](https://sysdig.com/blog/kubernetes-admission-controllers/?utm_sq=g6qty0qqim)

Kubernetes许可控制器是一个强大的Kubernetes本机特性，它可以帮助你定义和定制允许在集群上运行的内容。在对象持久化之前，并且在请求经过身份验证和授权之后，许可控制器拦截并处理对Kubernetes API的请求。

在这篇文章中，我们将演示如何将Kubernetes的许可控制器功能与Sysdig Secure集成起来，以便实施对部署在集群中的任何图像执行图像扫描和自定义安全策略。

## 实施安全默认部署  将#Kubernetes许可控制器与Sysdig安全集成

通过扩展API功能，你能连接可以修改请求(MutatingAdmissionWebhook)或决定是否允许它运行(ValidatingAdmissionWebhook)的任何代码段。正如我们刚才提到的，这是在请求被持久化到etcd中之前完成的，也就是说，在执行之前完成。这些特性使Kubernetes的录取控制器成为在集群上部署预防性安全控制的最佳选择。

这些控制器被编译到kube-apiserver二进制文件中，并且只能由集群管理员启用或更新。下图展示了许可控制器如何参与Kubernetes资源创建的工作流程:

![](https://478h5m1yrfsa3bbe262u7muv-wpengine.netdna-ssl.com/wp-content/uploads/2019/06/admission_controllers_diagram.png)

如上图所示，Kubernetes API服务器和自定义代码实现两者之间的通信使用了相当标准的webhook接口，简化了与任何第三方代码的集成和接口。

### Kubernetes的许可控制器做些什么?

集装箱化的微服务通常运行在动态创建并临时运行的pods中。这些特性对于软件生命周期来说是革命性的，但是它们使云本地安全成为一个快速移动的目标。每当我们创建或自动扩展新的部署和pods时，集群管理员需要回答许多问题:

pods是否需要太多的资源?

这些基础图像是否会繁衍出更多的微服务pods安全?

与其他部署相比，这种部署的优越性是什么?

例如，如果集群资源不足，需要清理pods

连接到此pods或者部署的服务帐户当前被授予哪些特权?

他们是否坚持了最低特权原则?

能够回答这些问题对于运行可靠和安全的服务至关重要。每个组织都有自己的策略和常规的最佳方法。这就产生了对“插件”策略机制的需求，这种策略机制能够扩展Kubernetes API的功能，而不会增加其基本代码的复杂性。

你可能已经运行了几个Kubernetes许可控制器，这些控制器是在标准部署中预先配置好的。这是一组推荐的Kubernetes许可控制器，你可以在任何普通部署中找到:

```yaml
--enable-admission-plugins=NamespaceLifecycle,LimitRanger,ServiceAccount,DefaultStorageClass,DefaultTolerationSeconds,MutatingAdmissionWebhook,ValidatingAdmissionWebhook,Priority,ResourceQuota,PodSecurityPolicy
```


注意，Kubernetes的某些方面(你可能认为是内建的)实际上是由这些控制器强制执行的，比如pod优先级或对资源请求的限制。

这些许可控制器可以扮演不同的角色，从资源控制到供应和安全方面。下面是一些在Kubernetes中支持的许可控制器的例子:

Pod安全策略:这个许可控制器处理Pod的创建和修改，并根据请求的安全背景和可用的Pod安全策略确定是否应该允许它。

Persistent Volume Claim调整大小:此许可控制器实现了用于检查Persistent Volume Claim调整大小请求的附加验证。

Validating Admission Web hook:这个许可控制器调用任何与请求匹配的验证web hook。匹配的web hook是并行调用的;如果其中任何一个拒绝请求，则请求失败。我们可以很容易地通过调整这些web hook来实现我们的自定义安全策略。

足够的理论，让我们开始实施一个真正使用Kubernetes的安全案例。

### 案例:集成Sysdig安全图像扫描作为你的Kubernetes许可控制器之一

sysdig Secure提供了一种简洁的方式，将你的kubernetes集群与sysdig Secure Image Scanning和kubernetes遵从性集成在一起。一个高层次的工作流程图如下:

![](https://478h5m1yrfsa3bbe262u7muv-wpengine.netdna-ssl.com/wp-content/uploads/2019/06/admission_controllers_sysdig_integration.png)

在这种情况下，webhook提供者将是一个居住在您自己的Kubernetes集群中的pod。这个pod将负责将自己注册为验证许可的Webhook，解析API请求并将图像定义转发到Sysdig Secure。

然后Sysdig Secure将检索图像并验证它是否符合配置的安全策略。此安全验证决策将传播回APl, APl将应答原始请求者，并且只有当映像通过检查时才将对象存留到etcd数据库中。

只需要几个步骤就可以在上面提到的工作流中集成Sysdig安全图像扫描。

#### 步骤1:使用Sysdig Secure创建图像扫描策略

![](https://478h5m1yrfsa3bbe262u7muv-wpengine.netdna-ssl.com/wp-content/uploads/2019/06/sysdig_secure_policy.png)

Sysdig Secure利用一个开源扫描引擎来分析运行环境、注册表或Cl/CD管道中图像的内容。当你创建一个会被Kubernetes许可控制器触发规则,第一步明显是要检查图像中的漏洞,但有那么多（图像）,你可以执行不同的控制器Sysdig安全政策置于你的处理:从Dockerfile规则到软件许可、文件,文件权限,允许有效用户特定语言包和元数据属性,仅举这几例。在这里，你可以更全面地描述你可能希望配置的Sysdig安全图像扫描策略控制器和触发器。

一旦你定义了一个安全控制器，你将决定这是否是一个停止条件(在这种情况下，许可控制器将拒绝部署)还是一个将反映在图像报告中的安全警告。

对于我们在上图中配置的示例策略，我们正在校验:

此图像的漏洞反馈数据不超过一周

图像没有漏洞(被认为是高水平的或临界的)

端口22没有在Dockerfile中公开

此图像的有效用户不是根用户

#### 步骤2:配置webhook并部署许可控制器

在Kubernetes集群中部署这种集成非常简单。首先，确保将kubectl安装并配置为指向目标集群。

然后，将项目存储库和cd签出到新目录中:

```shell
git clone git@github.com:sysdiglabs/image-scanning-admission-controller.git
```


然后，你需要宣布两个操作系统环境变量:

```yaml
export ANCHORE_CLI_URL="https://api.sysdigcloud.com/api/scanning/v1/anchore"
export ANCHORE_CLI_USER="xxxxxxx-xxxx-xxxxxx-xxxxxx-xxxxx"
```


对于端点URL和API访问令牌，如果使用的是Sysdig Secure的Saas版本，你可以使用上面的URL，否则需要替换该地址的主体部分。你可以找到你的 APl访问令牌访问Sysdig安全配置文件上的设置菜单。

要有效部署，您只需执行部署命令：

```yaml
$ make deploy
+ deploy
./scripts/deploy.sh
namespace/image-scan-k8s-webhook-system created
clusterrole.rbac.authorization.k8s.io/image-scan-k8s-webhook-manager-role created
clusterrolebinding.rbac.authorization.k8s.io/image-scan-k8s-webhook-manager-rolebinding created
secret/image-scan-k8s-webhook-webhook-server-secret created
secret/sysdig-secure-token created
service/image-scan-k8s-webhook-controller-manager-service created
statefulset.apps/image-scan-k8s-webhook-controller-manager created
+ sleep 3
+ kubectl get all -n image-scan-k8s-webhook-system
NAME                                              READY   STATUS              RESTARTS   AGE
pod/image-scan-k8s-webhook-controller-manager-0   0/1     ContainerCreating   0          3s

NAME                                                        TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)   AGE
service/image-scan-k8s-webhook-controller-manager-service   ClusterIP   10.104.71.12   <none>        443/TCP   3s

NAME                                                         READY   AGE
statefulset.apps/image-scan-k8s-webhook-controller-manager   0/1     3s
```


#### 步骤3:验证设置

最后一步创建了image-scan-k8 -webhook-system。让我们确保webhook提供商是启动并且运行着的:

```
$ kubectl get pods -n image-scan-k8s-webhook-system
NAME                                          READY   STATUS    RESTARTS   AGE
image-scan-k8s-webhook-controller-manager-0   1/1     Running   1          25m
```


你还可以验证ValidatingWebhoolkConfiguration是否已在Kubernetes APl中注册:

```
$ kubectl get ValidatingWebhookConfiguration
NAME                               CREATED AT
validating-webhook-configuration   2019-05-29T10:45:10Z
```

如果进一步检查这个目标，你将能够看到webhook服务配置(以及许多其他属性)：

```
$ kubectl describe ValidatingWebhookConfiguration      
...
   Service:
      Name:        webhook-server-service
      Namespace:   image-scan-k8s-webhook-system
      Path:        /validating-create-pods
...
```

#### 步骤4:测试Sysdig安全集成

现在你的许可控制器正在运行，并准备检查你在集群中生成的任何新图像。你可以尝试与自己的图像进行集成，但是为了简化测试，我们还提供了两个默认部署。一个通过了安全过滤器，另一个没有。

运行:

```yaml
$ make test
```


几秒过后：

```yaml
$ kubectl get deploy 
NAME              DESIRED   CURRENT   UP-TO-DATE   AVAILABLE   AGE
apache-struts2    1         0         0            0           5m
nginx             1         1         1            1           5m
```


Nginx部署通过了策略评估检查，所以pod以可用状态运行。部署apache-struts2未能运行，因为它包含一个非常严重的漏洞cve-2017-5638。你可以检查Kubernetes记录以获得请求响应；

```yaml
$ kubectl get events
LAST SEEN   TYPE      REASON                    OBJECT                                MESSAGE
67s         Warning   FailedCreate              replicaset/apache-struts2-8bb7bd7b   Error creating: admission webhook "validating-create-pods.k8s.io" denied the request: Image failed policy check: kaizheh/apache-struts2-cve-2017-5638
```


另外，当你在集群中通过访问Sysdig安全接口配置这个webhook时，你将拥有生成的任何图像的完整扫描报告。如果打开界面并导航到图像扫描，资源库选项卡将会找到一个搜索框。（在这里）你可以查看自己提交的用于显示安全报告的图像的名称和标签:

![](https://478h5m1yrfsa3bbe262u7muv-wpengine.netdna-ssl.com/wp-content/uploads/2019/06/sysdig_secure_security_report.png)

注意:Kubernetes API为webhook验证设置了30秒的超时，如果这是你第一次部署给定的图像，那么如果在这段时间内APl没有响应，则许可控制器将拒绝你的请求。你可以调优配置环境变量的默认超时行为，如果在图像扫描-许可-控制器中出现超时，则拒绝。yaml文件。

## 结论

Kubernetes许可控制器和Sysdig APl都提供了一种简单而安全的机制来集成任何支持webhook调用的第三方。通过在集群中部署这种集成，你可以在集群中请求的任何pod(甚至在它被调度之前)全面实施Sysdig安全图像扫描策略和安全控制器。默认的强制安全是最好的安全类型之一，它将极大地增加你作为Kubernetes操作员的安心。

你可以在这里获得webhook提供程序的源代码。