# observability 模式

正如被开发的用来规范应用程序中的代码布局的模式一样，也存在一些用于以可靠方式操作应用程序的模式。产生了三种有效维护应用程序的模式：**logging**, **monitoring**和 **alerts**。

# 何时使用logging
无论我们多么谨慎，应用程序在生产中几乎总是以无法预料的方式运行。当用户报告应用程序问题时，能够在问题发生时查看应用程序的运行状况，这一点非常有用。捕获有关应用程序在运行时正在执行的操作的信息的经实践的，最真实的方法之一是让应用程序记下其正在执行的操作。此过程称为logging。生产中发生故障或问题时，目标应是在非生产环境中重现故障发生的条件。拥有良好的日志记录为开发人员提供了一个路线图，以便在可以测试和试验的环境中再现问题。

## 使用cloud-native应用程序logging时的问题
在传统应用程序中，日志文件通常存储在本地计算机上。实际上，在类Unix的操作系统上，有一个特定的文件夹结构用于保存日志，通常在/var/log路径下。

![Figure 7-1](https://img-blog.csdnimg.cn/20200407110018893.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Mjk5NjU5NQ==,size_16,color_FFFFFF,t_70)
图7-1. 在monolithic应用程序中记录日志文件

在云环境中，单台计算机上记录平面文件(flat file)的有效性大幅降低。应用程序记录日志可能不必访问本地磁盘，或者高速地切换物理机的本地磁盘来作为瞬时的容器。即使只是简单地跨多个节点来扩展单片应用程序都可能为查找合适的基于文件的日志文件带来挑战。

![Figure 7-2](https://img-blog.csdnimg.cn/20200407112601283.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Mjk5NjU5NQ==,size_16,color_FFFFFF,t_70)

图 7-2. 在scaled monolithic应用程序中记录日志文件

使用微服务架构开发的cloud-native应用程序也给基于文件的日志记录带来了一些挑战。现在，用户请求可能会跨越在不同计算机上运行的多个服务，并且可能包括无需访问本地文件系统的无服务器功能。这使得在许多服务和机器之间关联来自用户或会话的日志将非常具有挑战性。

![Figure 7-3](https://img-blog.csdnimg.cn/20200407115342661.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Mjk5NjU5NQ==,size_16,color_FFFFFF,t_70)
图 7-3. 在microservices应用程序中记录日志文件

最后，某些cloud-native应用程序中的用户数量很高。假设每个用户登录到应用程序时都会生成一百行日志消息。不考虑其他因素，这是可管理的，但是将其乘以超过100,000的用户数量，并且日志量变得足够大，就需要有效地使用特定的工具来支撑日志的记录。

## cloud-native应用程序中的logging
每种编程语言都有允许写入日志的工具，通常，写入这些日志的开销很低。许多日志记录库都提供了各种不同的临界值，可以在运行时对其进行调整。例如，Serilog库是.NET常用的结构化日志记录库，它提供以下日志记录级别：

- Verbose
- Debug
- Information
- Warning
- Error
- Fatal

这些不同的日志级别给出了日志记录的粒度。当应用程序在生产中正常运行时，可以将其配置为仅记录重要消息。当应用程序行为异常时，可以提高日志级别，以便收集更多详细的日志。这在性能与调试方便之间取得了平衡。

日志记录工具的高性能和可调整的详细度激励开发人员频繁记录日志。许多人喜欢的一种模式是：记录每种方法进入和退出的日志。这种方法听起来有些过分，但是很少有开发人员希望减少日志记录。实际上，仅出于在有问题的方法周围添加日志记录的目的而执行部署并不少见。错误是因为日志过多而不是过少。可以使用某些工具来自动提供这种日志记录。

由于在cloud-native应用程序中使用基于文件的日志会带来挑战，因此将日志集中处理较好。应用程序收集日志并传送到中央日志记录应用程序，该应用程序对日志进行索引和存储。此类系统每天可以摄取数十GB的日志。

在构建涵盖许多服务的日志时，遵循一些标准做法也很有帮助。例如，在一个冗长的交互开始时生成相关ID，然后将其记录在与该交互相关的每条消息中，这样可以更容易地搜索所有相关的消息。只需找到一条消息并提取关联ID即可找到所有相关消息。另一个示例是确保每种服务的日志格式相同，无论其使用哪种语言或日志库。这种标准化使阅读日志变得更加容易。图7-4演示了微服务架构如何将集中式日志记录作为其工作流程的一部分。

![Figure 7-4](https://img-blog.csdnimg.cn/20200407130955520.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Mjk5NjU5NQ==,size_16,color_FFFFFF,t_70)
图 7-4 各种来源的日志被提取到集中式日志存储中

# 检测和响应潜在的应用程序健康问题的挑战
某些应用程序不是任务流程中的关键部分。也许它们仅在内部使用，并且当出现问题时，用户可以联系负责的团队，并且可以重新启动应用程序。但是，客户通常会对所使用的应用程序抱有更高的期望。在用户遇到问题之前或在用户通知您之前，您应该知道应用程序何时出现问题。否则，您首先面对的问题可能是：当您注意到气愤的社交媒体帖子泛滥成灾时，这些帖子嘲笑着您的应用程序甚至您的组织。

您可能需要考虑的一些场景包括：

- 应用程序中的一项服务不断失败并重新启动，导致间歇性的响应缓慢。
- 在一天中的某些时候，您的应用程序的响应时间很慢。
- 最近的部署后，数据库上的负载增加了两倍。

实施得当，monitoring可以使您知道可能导致问题的状况，并在潜在状况对用户造成严重影响之前解决潜在状况。

## 监控cloud-native应用程序

一些集中式日志记录系统还在单纯的日志日志记录之外承担了收集遥测数据的额外作用。他们可以收集指标，例如运行数据库查询的时间，来自Web服务器的平均响应时间，甚至包括操作系统报告的CPU负载平均值和内存压力。结合日志，这些系统可以提供系统和整个应用程序中节点健康的整体视图。

监控工具的数据指标收集功能也可以从应用程序中手动输入。可以检测特别感兴趣的业务流，例如新用户注册或正在下订单，以便它们在中央监控系统中增加计数器。这将拓展监视工具，以便不仅监视应用程序的运行状况，而且监视业务的运行状况。

可以在日志集中工具中发起查询，以查找特定的统计信息或模式，然后可以在自定义仪表板上以图形形式显示这些统计信息或模式。通常，团队会投资于大型壁挂式显示器，这些显示器将相关的应用程序统计数据进行轮播。这样，就很容易在问题发生时发现它。

cloud-native监控工具提供实时遥测和对应用程序内部状况的洞察，而不管它们是单进程monolithic应用程序还是分布式微服务架构的应用程序。它们包括允许从应用程序收集数据的工具，以及用于查询和显示应用程序运行状况信息的工具。

# 应对cloud-native应用程序的重大问题的难点
如果您需要对应用程序的问题作出应对，则需要某种方式来向相应人员进行告警。这就是cloud-native应用程序observability 模式的第三种方式，该方式是在日志记录和监视的基础上的。您的应用程序需要有适当的日志记录以便于诊断问题，在某些情况下还需要将其输入到监控工具中。它需要监视以将应用程序指标和运行状况数据集中到一处。只要这一点实现了，就可以创建规则，在某些指标超出预期值时触发警报。

通常，警报是在监视的基础上分级的，这样某些情况下对于紧急问题会触发适当的警报来通知团队成员。一些可能需要警报的场景包括：

- 应用程序的某个服务在停机1分钟后没有响应。
- 您的应用程序正在向超过1%的请求返回不成功的HTTP响应。
- 应用程序对关键端点的平均响应时间超过2000毫秒。

## cloud-native应用程序中的Alters
您可以针对监视工具手工查询，以查找已知的故障情况。例如，查询传入的日志，可以检索到HTTP状态代码为500的指示，这表示web服务器上存在问题。一旦检测到其中一个服务器有问题，就可以向服务的提供者发送电子邮件或短信息，后者可以开始调查问题。

不过，通常情况下，单个500错误码不足以确定问题是否已发生。这可能意味着用户输入了错误的密码或输入了一些格式错误的数据。只能在检测到平均500个错误以上的情况下，触发告警查询。

警报中最具破坏性的模式之一是发出太多警报以供调查。服务提供者将很快对他们之前调查过并发现是良性的错误变得不敏感。然后，当恶性的错误发生时，它们就会消失在成百上千的误报声中。经常告诉孩子们的寓言故事“狼来了”就说明了这种行为的危险性，要他们注意这个危险。重要的是，确切地触发告警才能真正地指出问题所在。