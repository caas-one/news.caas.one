# 编写Kubernetes自定义控制器
作者：CloudARK
原文链接：[Writing Kubernetes Custom Controllers](https://medium.com/@cloudark/kubernetes-custom-controllers-b6c7d0668fdf)

新闻:这篇文章现在已经被Kubernetes官方文档所接受

Kubernetes的力量在于它的可扩展性。扩展Kubernetes的方法之一是编写自己的自定义控制器。你可以编写自定义控制器处理Kubernetes内置对象，比如以新的方式部署、服务，或者您可以在Kubernetes中添加新的自定义资源，并编写一个自定义控制器来处理这些新资源。

最近我们为Postgres开发了一个Custom Resource Definition（CRD），在开发这个CRD的时候，我们花费了一些时间研究Kubernetes的client-go库。这个库包含你开发自定义控制器时可以使用的各种机制。这些机制被定义在库的tools/cache文件夹中。
我们已经将client-go库中的各种组件及您将编写的自定义控制器代码的交互点的工作方式的图形表示放在一起。

这就是那个图表。
![](file:///C:\Users\sujia\Desktop\1_dmvNSeSIORAMaTF2WdE9fg[1].jpg)

图片被分成两部分——client-go和自定义控制器。

下面我们将解释每个组件在client-go代码中的适当位置，以及展示Postgres自定义控制器的每个组件的主要操作。

client-go组件

1.Reflector：一个监视指定资源类型的Kubernetes反射器API。这可以是一个内置的资源，也可以是一个自定义的资源。当它通过监控 API接收到关于新资源实例存在的通知时，它使用相应的清单API获取新创建的对象。然后将对象放入Delta Fifo队列中。

2.Informer：informer是从Delta Fifo队列中弹出的对象。它的工作是保存对象供以后检索，并调用将对象传递给它的控制器代码。

3.Indexer:一个索引器提供对对象的索引功能。一个典型的索引用例是创建一个基于对象标签的索引。Indexer可以基于多个索引函数维护索引。Indexer使用线程安全的数据存储来存储对象及其键。有一个默认函数生成对象的键值为该对象的<namespace>/<name>组合。

自定义控制器组件

1.Informer reference:这是对Informer实例的引用，该实例知道如何使用自定义资源对象。您的自定义控制器代码需要创建适当的Informer。

2.Indexer reference:这是对Indexer实例的引用，该实例知道如何使用自定义资源对象。您的自定义控制器代码需要创建它。您将使用这个引用来检索对象以供以后处理。client-go提供了和你需求相符的Informer和Indxer的功能。在您的代码中，您可以直接调用这些函数，也可以使用factory方法来创建informer。

3.Resource Event Handlers:这些是回调函数，当Informer想要向您的控制器交付对象时，它将调用这些回调函数。编写这些函数的典型模式是获取调度对象的密钥并将该密钥放入工作队列中进行进一步处理。

4.Work queue:这是在控制器代码中创建的队列，用于对象的交付与其处理。编写资源事件处理程序函数来提取已交付对象的键并将其添加到工作队列。

5.Process Item:这是您在代码中创建的用于处理工作队列中的项的函数。可以有一个或多个其他函数执行实际的处理。这些函数通常使用Indexer引用或清单包装器来检索与键对应的对象。

您可以尝试我们的Postgres自定义资源，看看这些组件如何在实际代码中组合在一起。这个自定义资源是根据Kubernetes中可用的示例控制器开发的。

我们希望以上对编写自定义Kubernetes控制器所涉及的各种组件和机制的解释能够帮助您编写自己的自定义控制器。