# HTTP/2上的gRPC:设定一个稳健的、高性能的通信草案

作者：Jean de Klerk 
原文链接：[gRPC On HTTP/2: Engineering A Robust, High Performance Protocol](https://www.cncf.io/blog/2018/08/31/grpc-on-http-2-engineering-a-robust-high-performance-protocol/)
本文由谷歌的开发人员程序工程师Jean de Klerk撰写

在前一篇文章中，我们探讨了HTTP/2如何通过提供长期连接的框架来显著提高网络效率并支持实时通信。在本文中，我们将了解gRPC如何构建在HTTP/2的长期连接上以创建一个高效、稳健的服务间通信平台。gRPC是一个高性能、开源的通用RPC框架。我们将探讨gRPC和HTTP/2之间的关系，gRPC如何管理HTTP/2连接，以及gRPC如何使用HTTP/2保持连接的活性、稳定和利用。

## gRPC语义
首先，让我们深入了解gRPC概念与HTTP/2概念之间的关系。gRPC引入了三个新概念:通道(1)、远程过程调用(RPCs)和消息。三者之间的关系很简单:每个通道可能有许多RPC，而每个RPC可能有许多消息。

 ![](https://www.cncf.io/wp-content/uploads/2018/08/Screen-Shot-2018-08-27-at-10.40.40-AM-300x241.png)
 
让我们看看gRPC语义如何与HTTP/2相关联:

![](https://www.cncf.io/wp-content/uploads/2018/08/Screen-Shot-2018-08-27-at-10.41.00-AM-300x246.png)
 
通道是gRPC中的一个关键概念。HTTP/2中的数据流允许在一个连接上进行多个并发对话;通道通过在多个并发连接上启用多个数据流扩展了这一概念。表面上，信道为用户发送信息提供了一个方便的界面;然而，更深层次上，这需要大量的工程技术来保持这些连接的高效与稳定。

通道代表着到端点的虚拟连接，在现实中，端点可能由与某个连接与其相关的许多HTTP/2连接做支撑。RPCs和其中一种连接有关(后面将进一步描述这种关联)。RPCs实际上是纯HTTP/2数据流。与RPCs相关的信息以HTTP/2数据帧的形式发送。更具体地说，信息层位于数据帧之上。一个数据帧可能有许多gRPC信息，或者说如果一个gRPC消息非常大(2)，它可能会分解多个数据帧。

## 解析器和负载平衡器
为了保持连接的稳定、处于通有电流状态及其可用性，gRPC使用了许多组件，其中最重要的被称为解析器和负载平衡器。解析器将名称转换为地址，然后将这些地址交给负载平衡器。负载平衡器负责从这些地址创建连接，并在连接之间创建负载平衡PRCs。

 ![](https://www.cncf.io/wp-content/uploads/2018/08/Screen-Shot-2018-08-27-at-10.41.21-AM-300x183.png)
 
 ![](https://www.cncf.io/wp-content/uploads/2018/08/Screen-Shot-2018-08-27-at-10.41.40-AM-300x210.png)
 
例如，DNS解析器可能会将一些主机名解析为13个IP地址，然后一个RoundRobin均衡器可能会创建13个连接—每个地址一个连接，每个连接上有一个轮询rpc。更简单的平衡器可以简单地创建到第一个地址的连接。或者，如果用户需要多个连接，但知道主机名只会解析为一个地址，那么他们的平衡器可能会针对每个地址创建10次连接，以确保使用多个连接。

在gRPC系统中，解析器和负载均衡器可以解决小而关键的问题。这种设计是有意的:将问题空间减少到几个小的、不连续的问题有助于用户构建自定义组件。这些组件可用于微调gRPC以适应每个系统的不同需求。


## 连接管理
一旦配置好，gRPC将保持由解析器和平衡器界定的连接池的稳定、通有电流的状态和可用性。
当一个连接失败时，负载均衡器将开始重新连接使用最后一个已知的地址列表(3)。同时，解析器将开始尝试重新解析地址列表。这在许多场景中都很有用。例如，如果警用接口不再是可访问的，我们希望解析器更新地址列表里不包含警用接口的地址。再举一个例子:DNS条目可能随时间变化，因此地址列表可能需要定期更新。通过这种方式和其他方式，gRPC是为了长期的弹性函数而设计的。

一旦解析完成，负载均衡器就会获得新的地址。如果地址发生了变化，负载均衡器可能会向下旋转到新列表中不存在的地址的连接，或者创建到以前不存在的地址的连接。


## 识别失败连接
gRPC连接管理的有效性取决于它识别失败连接的能力。通常有两种类型的连接故障，一种是清理故障，在这种故障中，故障是可以进行通信的，另一种是较少清理故障，在这种故障中，故障不能进行通信。

让我们想象一个可清理的、易于观察的故障。当端点有意终止连接时，可能会发生清理故障。例如，端点可能已经正常关闭，或者已经超过了计时器，它提示端点关闭连接。当连接彻底关闭时，TCP语义就足够了:关闭连接会导致FIN的信号互换。这将结束HTTP/2连接，该连接将结束gRPC连接。gRPC将立即开始重新连接(如上所述)。这是相当完全的，不需要额外的HTTP/2或gRPC语义。

清理不完全的版本是端点终止或挂起而不通知客户端。在这种情况下，TCP可能要重试10分钟才能被认为连接失败。当然，如果10分钟内没有意识到连接已经断开，这是不可接受的。gRPC使用HTTP/2语义解决了这个问题:当配置使用保持连接时，gRPC将定期发送HTTP/2 PING帧。这些帧绕过旁流控制，用于确定连接是否处于连接状态。如果PING响应没有及时返回，gRPC将认为连接失败，关闭连接，并开始重新连接(如上所述)。

通过这种方式，gRPC保持连接池的稳定状态，并定期使用HTTP/2来确定连接的稳定。所有这些特性对用户来说都是难懂的，他们认为消息重定向是自动进行的。用户只是简单地在一个看似永远稳定的连接池中发送消息。


## 保持连接畅通
如上所述，KeepAlive提供了一个有价值的好处:通过发送HTTP/2 PING来定期检查连接的稳定状况，以确定连接是否仍然是带电的。然而，它还有另一个同样有用的好处:向警用接口发送实况信号。

考虑到客户机通过警用接口向服务器发送数据。客户端和服务器会很乐意无限期地保持连接，根据需要发送数据。另一方面，警用接口常常受到资源的限制，可能会断开空闲连接以节省资源。谷歌云平台(GCP)负载平衡器在10分钟后断开明显空闲的连接，而亚马逊网页服务弹性负载平衡器(AWS ELBs)在60秒后断开连接。

使用gRPC在连接上定期发送HTTP/2 PING帧，就可以创建非空闲连接的感知。使用前面提到的断开空闲连接规则的端点会跳过断开这些连接。

## 一个稳健的、高性能的通信草案
HTTP/2为长时间的实时通信流提供了基础，gRPC在此基础上构建了连接池、稳定语义、高效使用数据帧和多路复用以及保持活性。

选择通信草案的开发人员必须选择既满足当前需求又满足未来需求的草案。他们通过选择gRPC得到了很好的服务，无论是弹性、性能、长期或短期的通信、可定制性，或者是仅仅知道他们的草案将扩展到非常巨大的通信量，同时始终保持高效。要立即使用gRPC和HTTP/2，请查看gRPC的入门指南。

(1)	在围碁程式(Go)中，gRPC通道被称为ClientConn，因为单词“channel”具有特定于语言的含义。
(2)	(2)gRPC对16kb的数据帧使用HTTP/2默认的最大大小。超过16kb的消息将跨越多个数据帧，而小于16kb的消息将与一些其他消息共享一个数据帧。
(3)这是RoundRobin均衡器的性能，但并不是每个负载均衡器都这样做或必须这样做。


