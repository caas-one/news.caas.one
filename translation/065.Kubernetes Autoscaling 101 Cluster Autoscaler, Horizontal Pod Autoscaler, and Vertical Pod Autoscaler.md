# Kubernetes自动标度101:集群自动标度，水平荚自动标度，垂直荚自动标度

作者：Mohamed Ahmed 原文链接：[Kubernetes Autoscaling 101: Cluster Autoscaler, Horizontal Pod Autoscaler, and Vertical Pod Autoscaler](https://medium.com/magalix/kubernetes-autoscaling-101-cluster-autoscaler-horizontal-pod-autoscaler-and-vertical-pod-2a441d9ad231)


Kubernetes的核心是一个资源管理和编排工具。我们可以将第一天的工作重点放在探索和玩转其酷炫的功能，以部署、监控和控制您的pod。不过，你也需要考虑第二天的操作。你需要关注以下问题：


* 我将如何缩放pod和应用程序？

* 如何使容器保持正常运行并高效运行？

* 随着代码和用户工作负载的不断变化，我如何跟上这些变化？

> 在本文中，我将对Kubernetes中的不同可伸缩性机制以及使它们满足您需要的最佳方法进行一个高层次的概述。记住，要真正掌握Kubernetes，您需要掌握不同的方法来管理集群资源的规模，这是Kubernetes承诺的核心。



配置Kubernetes集群以平衡资源和性能可能是一项挑战，需要对Kubernetes的内部工作有专业知识。仅仅因为你的应用程序或服务的工作量不是固定的，所以它会在一天中波动，如果不是一小时的话。把它看作一个行程和持续的过程。

## Kubernetes自动缩放构建块


有效的kubernetes自动缩放需要两层可伸缩性之间的协调：（1）Pods层自动缩放器，这包括水平Pod自动缩放器（HPA）和垂直Pod自动缩放器（VPA）；两者都可以缩放容器的可用资源，以及（2）集群级可伸缩性，由集群自动缩放器（CA）管理；它可以向上缩放或减少集群内的节点数。

## 水平Pod自动缩放器（HPA）

顾名思义，HPA可以扩展pod副本的数量。大多数DevOps使用CPU和内存作为触发器来扩展更多或更少的pod副本。但是，您可以将其配置为基于自定义度量、多个度量甚至外部度量来扩展pod。

## 高级HPA工作流

![](https://miro.medium.com/max/1972/1*xfpzh3ir2vgsp246yk9keg.png)

1. HPA以默认的30秒间隔持续检查您在安装期间配置的度量值

2. 如果达到指定的阈值，HPA将尝试增加pod的数量

3. HPA主要更新部署或复制控制器内的副本数

4. 然后，部署/复制控制器将推出任何其他所需的pod

### 在推出HPA时，请考虑以下几点：

* 默认的HPA检查间隔为30秒。这可以通过控制器管理器的horizontal-pod-autoscaler-sync-period标志配置

*  默认的HPA相对度量公差为10%

* HPA在最后一个放大事件之后等待3分钟，以使度量稳定。这也可以通过horizontal-pod-autoscaler-sync-period标志配置

* HPA从上次缩放事件开始等待5分钟，以避免自动缩放器抖动。可配置通过horizontal-pod-autoscaler-sync-period标志缩小延迟

* 与复制控制器不同，HPA最适合用于部署对象。无法使用复制控制器的直接操作滚动更新。在进行部署时，依赖于部署对象来管理底层副本集的大小

## 垂直Pod自动缩放器（VPA）

垂直Pod自动缩放器（VPA）将更多或更少的CPU或内存分配给现有的POD。可以把它看作是给pods一些生长激素：）它可以同时对有状态和无状态的pods起作用，但它主要是为有状态的服务构建的。但是，如果希望实现对最初分配给pod的资源的自动更正，也可以将其用于无状态pod。VPA还可以对OOM（内存不足）事件作出反应。VPA要求当前重启pods以更改分配的cpu和内存。当VPA重新启动pods时，它会遵守pods分发预算（PDB），以确保始终存在所需的最小pods数量。您可以设置VPA可以分配给任何pod的最小和最大资源。例如，可以将最大内存限制限制为不超过8 GB。当您知道当前节点不能为每个容器分配超过8 GB的空间时，这尤其有用。阅读VPA的官方wiki页面了解详细的规范和设计。

VPA还有一个有趣的特性，称为VPA推荐程序。它监视所有pod的历史资源使用和OOM事件，以建议“请求”资源规范的新值。建议者通常使用一些智能算法，根据历史度量计算内存和cpu值。它还提供了一个接受pod描述符并提供建议的资源请求的API。

> 值得一提的是，VPA推荐程序并不致力于设置资源的“限制”。这会导致pod独占节点内的资源。我建议您在名称空间级别设置一个“limit”值，以避免内存或CPU的疯狂消耗


## 高级VPA工作流

![](https://miro.medium.com/max/1960/1*dxjzbfl_tfedovzlpuzjoa.png)

1. VPA以默认的10秒间隔持续检查您在安装过程中配置的度量值

2. 如果达到阈值，VPA尝试更改分配的内存和/或CPU

3. VPA主要更新部署或复制控制器规范中的资源

4. 当pods重新启动时，新资源将全部应用于创建的实例。

### 在推出VPA时需要考虑以下几点：

* VPA和HPA还不兼容，不能在同一个pod上工作。如果在同一个集群中同时使用它们，请确保在设置中分离它们的作用域。

* VPA仅根据观察到的过去和当前资源使用情况调整容器的资源请求。它没有设置资源限制。如果应用程序开始使用越来越多的资源，导致pod被Kubernetes杀死，那么这可能会有问题。

* VPA处于早期阶段。它将在未来几个月内发展，为此做好准备：）关于已知限制的详细信息可以在这里找到，关于未来的工作也可以在这里找到

## 自动分级

群集自动缩放器（CA）根据挂起的pod缩放群集节点。它定期检查是否有任何挂起的pod，并在需要更多资源以及扩展后的集群是否仍在用户提供的限制范围内时增加集群的大小。CA与云提供程序接口以请求更多节点或释放空闲节点。它与GCP、AWS和Azure协同工作。版本1.0（GA）与kubernetes 1.8一起发布。

# 高级CA工作流

![](https://miro.medium.com/max/1600/0*i6hB9otN9tjzaK4f)

1. CA以默认的10秒间隔检查处于挂起状态的pod。

2. 如果有一个或多个pod处于挂起状态，因为集群上没有足够的可用资源在集群上分配它们，那么它将尝试提供一个或多个附加节点。

3. 当该节点由云提供商授予时，该节点将加入集群并准备为pod提供服务。

4. Kubernetes调度程序将挂起的pod分配给新节点。如果某些pod仍处于挂起状态，则会重复该过程并向集群添加更多节点。

### 当你推出CA时考虑这些

* Cluster Autoscaler确保集群中的所有pod都有一个运行的地方，不管是否有CPU负载。此外，它还试图确保集群中没有不需要的节点。（来源）

* CA在大约30秒内实现了可伸缩性需求。

* 默认情况下，CA会在节点变得不需要后等待10分钟，然后再将其缩小。

* CA有扩展器的概念。展开器提供不同的策略来选择要向其中添加新节点的节点组。

* 使用“cluster autoscaler.kubernetes.io/safe-to-evict”：“true”负责。如果你设置了许多你的吊舱或足够的pod，你将失去很多灵活性来缩小。

* 使用podfruptionbudgets来防止pod被删除，最终导致应用程序的一部分完全不起作用。

## Kubernetes自动定标器如何相互作用

如果你想达到自动缩放你的Kubernetes集群，你将需要使用pod层自动缩放与CA。他们的工作方式相对简单，如下图所示。

![](https://miro.medium.com/max/1600/0*6-M58_pIUhE0HE5f)

1. 在分配给现有pod的副本或资源下更新HPA或VPA。

2. 如果没有足够的节点来运行pods post scalability事件，CA就会发现一些或所有已缩放的pods处于挂起状态。

3. CA分配新节点

4. pod安排在已配置的节点上。

## 常见错误

我在不同的论坛上见过，比如Kubernetes slack channels和StackOverflow questions，这些问题都是由于许多DevOps在使用autoscaler时忽略了一些事实造成的。

HPA和VPA依赖于指标和一些历史数据。如果你没有分配足够的资源，你的pod将被OOM杀死，并且永远没有机会生成度量。在这种情况下，你的规模可能永远不会出现。

放大是对时间最敏感的操作。您希望在用户体验到应用程序中的任何中断或崩溃之前，您的pod和集群能够快速扩展。你应该考虑到你的pod和集群扩展所需的平均时间。

### 最佳案例-4分钟

1. 30秒-更新目标度量值：30-60秒

2. 30秒-HPA检查度量值：30秒->

3. <2秒-已创建播客并进入挂起状态-1秒

4. <2秒-CA看到挂起的pod并激发对provision节点的调用-1秒

5. 3分钟-云提供商提供节点，K8等待节点准备就绪：最多10分钟（取决于多个因素）

### （合理）最坏情况-12分钟

1. 60秒-更新目标度量值

2. 30秒-HPA检查度量值

3. <2秒-已创建pod并进入挂起状态

4. <2秒-CA看到挂起的pod并激发对provision节点的调用

5. 10分钟-云提供商提供节点&K8等待它们直到它们准备好几分钟（取决于多个因素，如提供商延迟、操作系统延迟、引导捆绑工具等）

不要混淆云提供商的可伸缩性机制和CA。CA在集群内工作，而云提供商的可伸缩性机制（如AWS内的asg）基于节点分配工作。它不知道您的pod或应用程序发生了什么。将它们一起使用将使集群不稳定且难以预测行为。

## TL；博士

* Kubernetes是一个资源管理和编排工具。管理pod和集群资源的第二天操作是掌握Kubernetes过程中的一个关键里程碑。

* 记住正确的心智模式，使用HPA和VPA关注pods的可伸缩性。

* 如果您对您的豆荚和容器的需求有很好的了解，建议您使用CA。

* 了解不同的自动缩放器如何协同工作将有助于您配置集群。

* 当涉及到需要多长时间来扩展pod和cluster时，一定要为最坏情况和最佳情况制定计划。