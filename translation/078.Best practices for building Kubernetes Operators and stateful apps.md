# 构建Kubernetes运营商和状态性的应用程序的最佳方法（78）

最近，Kubernetes社群开始支持运行大型状态性的应用程序，如数据库、分析和机器学习。例如，你可以使用StatefulSet工作负载控制器来维护每个pod的特性，并使用PersistentVolumes来保存数据，以便在服务重新启动后仍能保存数据。如果你的工作负载依赖于本地存储，那么可以将persistent volume与本地SSD一起使用，还可以将SSD持久磁盘用作引导磁盘，以提高不同类型工作负载的性能。

然而，对于许多高级用例，如备份、恢复和高可用性，这些核心Kubernetes基元可能还不够。这就是Kubernetes运营商的用武之地。它们提供了一种使用自定义资源和自定义控制器来使用特定于应用程序的逻辑扩展Kubernetes功能的方法。使用操作符模式，你可以将特定应用程序的领域知识编码到Kubernetes API扩展中。通过使用它，你可以使用kubectl创建、访问和管理应用程序，就像你对内置资源(如Pods)的操作一样。

在谷歌云上，我们使用运营商来更好地支持Kubernetes上的不同应用程序。例如，我们有以Kubernetes本地方式运行和管理Spark和Airflow应用程序的操作员。我们还在GCP市场上提供了这些操作符，用以提供简单的单击部署体验。Spark操作员代表用户自动运行Spark-submit，为按计划运行Spark作业提供计时程序支持，支持自动重启和重试应用程序，支持从本地Hadoop配置和谷歌云存储挂载数据。Airflow操作员为气流部署创建并且管理必要的Kubernetes资源，并支持创建具有不同执行器的气流调度器。

作为开发人员，我们在构建这些操作符中学到了很多。如果你正在编写自己的操作符来管理Kubernetes应用程序，下面是我们推荐的一些最佳方法。

### 1.为每个应用程序编写一个操作符

操作员可以自动化应用程序的各种功能，但它应该是特定于单个应用程序的。例如，Airflow(气流)通常与MySQL和Redis一起使用。你应该为每个应用程序编写一个操作符，而不是一个操作符包含所有这三个操作。而且为每个应用程序编写一个操作符提供了与每个应用程序的领域专长相关的更好的关注点分离。

### 2.使用像Kubebuilder这样的SDK

Kubebuilder是一个全面的开发工具包，用于构建和发布KubernetesAPls和控制器使用CRDs。使用Kubebuilder，你可以轻松地编写操作符，而不必了解Kubernetes库实现的所有底层细节。要了解更多信息，请查阅Kubebuilder书籍。

### 3.使用说明性的API

为运营商设计说明性的API，而不是命令式的API。这与KubernetesAPI的性质是说明性的相一致。使用说明性的API，用户只需要表达他们想要的集群状态，同时让操作员执行所有必要的步骤来实现它。相比之下，使用命令式API时，用户必须清楚地指定要执行哪些步骤才能实现所需的状态。

### 4.通过多个控制器划分功能

应用程序可能具有不同的特性，如缩放、备份、恢复和检验。一个操作符应该由多个控制器组成，这些控制器专门处理这些特性。例如，操作符可以有一个主控制器来衍生和管理应用程序实例，一个备份控制器来处理备份操作，一个恢复控制器来处理恢复操作。这通过更好的提取和更简单的同步循环简化了开发过程。请注意，每个控制器应对应于一个特定的CRD，以便每个控制器的职责范围是明确的。

### 5.使用不同期的同步循环

如果操作员在将当前集群状态调整为所需状态时检测到错误(例如，创建pod失败)，则应立即终止当前同步调用并返回错误。然后，工作队列应该在稍后的时间调度重新同步;同步调用不应该通过继续轮询集群状态来阻止应用程序，直到错误得到解决。类似地，启动和监测长时间运行的操作的控制器不应该同步地等待操作。相反，控制器应该返回睡眠状态，稍后再进行检查。

## 监测和记录应用程序

一旦编写了自己的操作符，就需要为应用程序启用日志记录和监测。这对新手来说可能很复杂。下面是一些你可以采取的最佳方法。

### 1.执行应用程序级、节点级和集群级的日志聚合

Kubernetes集群可以变得很大，特别是状态性的应用程序的集群。如果你为每个集装箱都保留日志，那么你可能会以无法管理日志数量而告终。为了解决这个问题，你可以聚合你的日志，可以通过聚合集装箱日志并过滤出满足一定严格程度和详细程度日志级别的日志消息来执行应用程序级日志记录。应用程序级别的聚合要求能够判断日志属于哪个应用程序。为此，你可能需要将特定于应用程序的细节集成到日志消息中，比如说为应用程序名称添加前缀。

类似地，对于节点级和集群级日志记录，你可以在一个节点或集群中聚合所有应用程序级日志。Kubernetes本身并不支持这个功能，所以你可能需要使用外部的日志工具，如谷歌Stackdriver、Elasticsearch、Fluentd或Kibana来执行聚合。

### 2.正确地标记你的参数，以便更容易地查看、聚合和分析

我们建议向参数指标添加标签，以便通过监视系统进行聚合和分析。例如，如果你正在使用Prometheus来分析Prometheus风格的参数，那么添加的标签将极大地帮助系统查询和聚合这些参数。

### 3.通过pod端点公开应用程序指标参数，以便进行抓取

与将应用程序参数写入日志、文件或其他存储介质不同，更可行的选择是让应用程序pod公开一个指标HTTP端点，以便监控工具的获取。这提供了更好的可发现性、一致性和与度量分析工具(如谷歌Stackdriver)的集成。实现这一点的好方法之一是使用开放源码的特定于应用程序的导出器来公开普罗米修斯式的指标参数。

要使Kubernetes上的状态性的应用程序像在虚拟机中一样容易，还需要做更多的工作，但是有了使用Kubernetes操作符编写自定义控制器的能力，我们已经取得了很大的进步。

想了解更多的Kubernetes开发经验和谷歌Kubernetes引擎(GKE)，看看这些最近的帖子:为开发人员与小环境看到我们更容易和更负担得起的运行,对于那些希望从开发人员直接看到我们策划的列表必须关注涵盖多种重要的话题的协商。在接下来的几周里，我们将围绕Kubernetes开发者体验发布更多内容，所以请关注我们的系列并通过@GCPcloud关注我们。
